# 対応チケット
- CHOBIIT-4
- CHOBIIT-28

# 今回のリリース後の不具合発覚について

## 発見された不具合

A. ログイン認証ありのアプリでレコード一覧表示時にエラー発生
B. クライアントのJSが古いためにエラーが表示された

以下、上記のA,Bについて、原因と再発防止を記載する。

## 原因
### A. ログイン認証ありのアプリでレコード一覧表示時にエラー発生
大きく２つ、『テストのやり方』と『ソフトウェアの保守性』に課題があると考えます。
・テストのやり方
　・そもそもログイン認証ありの場合のテストをしていなかった。
　　→実装内容から、認証あり・なしで機能差異があるようなものではなかったため、厳密にテストパターンを網羅しきれていなかった。
　　→しかしながら、コードの改修は入れていたので、改修したLambdaの処理を通すようなテストを計画すべきだった。開発段階からそういったテストをすべき。
　　→一方で、ソフトウェアの保守性をあげられれば、公開アプリでのテストは必要最低限で済ませることもできたはず。それについては後に記載。
・ソフトウェアの保守性
　・認証あり、なしのレコード一覧処理を実施する Lambda はそれぞれ１つずつ、計２つある。
　・この２つの関数で、似たようなコードが散見されることは認識しており、それらを共通化する必要があることも認識していたが、コードの統合を同時に実施していたことも考慮し、一旦は現行の chobiit の改修は最低限にしておいた方が統合がやりやすいと判断し、積極的なリファクタリングを行わなかった。
　　→今回不具合が発生した箇所も、本来なら共通化できる処理であったが、何かの拍子に違ったコーディングを入れ込んでしまい、差分が発生してしまった。
　　→現状の chobiit には、保守性を意識したような設計は（個人的には）無いので、適切にコードを分割・共有して、開発のしやすい形を目指す必要があることを再認識。それも含めての新環境の構築を目指しています。

### B. クライアントの JavaScript が古いためにエラーが表示された
・今回、クライアントから Backend(Lambda) に送るリクエストパラメータの破壊的な変更を行った。後方互換を保つ形では今回対応したバグの改修はできない、あるいは対応として不適切という判断。
・本来なら、クライアント側で最新のJSが適用されている状態で利用されるべきだが、そうなっていないケースがあり、発生した。
・開発チームが、アナウンスが必要かもしれないという認識にリリース前に至れなかったことも大きな一因。

## 再発防止について

### A. ログイン認証ありのアプリでレコード一覧表示時にエラー発生
・テストのやり方
　・改修したコードが実行されるようなテストケースを、開発段階から設計し動作確認をしてくことが必要。
　　→ miichisoft さんと認識共有し、今後のテスト設計・レビューの基準に取り込んでいく。
　・また、今回のケースではエラーが発生したのはバックエンドの Lambda Function であり、外部API呼び出しをモック化してしまえば、単体テストで十分気づけるレベルのものだったと考えており、単体テストから自動テストの取り組みを加速させていく必要がある。そのための設計や方針も決めていく。
・ソフトウェアの保守性
　・RikiyaOta の方で、現状の chobiit のコードについて、目指すべき姿を明確にし、設計に落とし込むことがまず必要。
　・こちらもある程度かたまり次第 miichisoft さんと共有し、バグ改修をしながらリファクタリングを進めていきたいと思います。
### B. クライアントのJSが古いためにエラーが表示された
・ユーザーへのアナウンスをする基準の見直し
　→こちらも、RikiyaOta の方でざっくり方針を決めて、さわっちさん・うえむさんと共有しながら運用に乗せられるよう計画します。
・JSのバージョンが上がったときに、キャッシュを利用せずに最新の JS を利用する仕組みを検討
　→HTML のスクリプトタグに version を示すような文字列を仕込む方法があるかもしれない。
・エンドユーザーにアナウンスする仕組みの実装を計画
　→チケット作成し、miichisoft さんと協力して実装を進めます

## Next Action

- [Novelworks & Miichisoft] テスト設計の方針の見直しとそれを運用し続ける方法を検討
- [Miichisoft] テスト観点のたたき台を作成する
- [Novelworks] 単体テスト含め、ソフトウェア設計の見直し
- [Novelworks] ユーザーへのアナウンスする基準の見直し
- [Novelworks & Miichisoft] エンドユーザーへのアナウンス機能の実装（CHOBIIT-34）