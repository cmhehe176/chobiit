# はじめに

chobiit のソースコードやシステムの作り方において、スムーズに開発をしていく上で障害となりうる **ソースコードの差分** が発生しているので、こちらの解消を少しずつ進めていく必要があると考えます。

# 発生している問題

- 日本版と US 版でソースコードが分かれている。
    - 日本版: https://github.com/NovelWorksInc/chobiit-prod/
    - US 版: https://github.com/NovelWorksInc/chobiit-us


- よって、1つの機能を改修するにも、2箇所にプルリクを投げる必要がある。
- 加えて、US 版は開発環境がないため、ぶっつけ本番でのリリースをせざるを得ない状況となっている。


# 問題の経緯

- 以前は、chobiit-dev/chobiit-prod/chobiit-us という3つのリポジトリが存在していた（※もっとあったが割愛）。
- chobiit-dev は、日本版 chobiit の開発用のコードという位置付けのようでした。 **このコードは本番では使われていない** です。


- chobiit-dev は使っていないので、chobiit-prod を開発環境でも動作できるよう改修をし、chobiit-dev リポジトリは廃棄しました。

- しかし、chobiit-prod/chobiit-us は差分が発生している。さらに、顧客に提供しているコードなので、安易に捨てることもできない。
- よって、少しづつ解消していくしかないという状況です。


# 解消の方針

## 基本方針

- バグ改修でよく触るコードを、バグ改修のタイミングなどで解消していく。
- 理由：
    - ファイルが多いので、一気に解消するのは手間だと考えます。
    - さらに、あまり触らないファイルも多く、よくバグが見つかる or ユーザーに使ってもらうことが多い画面・ファイルから少しづつ解消していくのが効果的かと思っています。（あまり触らないファイルの差分を解消できても、今後の旨味はあまりない）


## 差分解消の実例

- レコード一覧画面のフロントエンド：
    - https://github.com/NovelWorksInc/chobiit-prod/pull/45
- レコード一覧画面のバックエンド：
    - https://github.com/NovelWorksInc/chobiit-prod/pull/33



「日本語と英語を切り替えたいだけの差分」がかなり多いです。この点については、`chobiit-common/src/application/locale-service.ts`を実装して多言語対応をできるようにしたので、こちらを利用していただくことで簡単に解消できると考えます。

一方で、単純な文言の差以上のものもあります。（日本版ではここでこの関数を呼んでいるのに、US 版では呼んでいない、とか）

レコード一覧画面で解消した限りでは、単にどちらかに合わせるだけで問題ない場合が多いです。
が、開発環境で動作確認をして、適切に差分を解消するようにしてください。

## 注意1

レコード一覧画面では一部やってしまいましたが、以下のような処理は望ましくないです：

```javascript
if (process.env.CHOBIIT_LANG === "ja") {
    // ..........
}

if (process.env.CHOBIIT_LANG === "en") {
    // ..........
}
```

必要があるなら OK ですが、`if`を使っての条件分岐は混乱の元になるので、よりシンプルに環境変数のみの切り替えで動作を変えられうような構成を検討してください。


## 注意2

chobiit-prod に統合できたファイルは、chobiit-us からは削除してしまった方がわかりやすいと思います。

もし chobiit-us でビルドコマンドを叩いても、ファイルが生成されなかったりと誤解がない気がします。


# より次の段階

- 当面は、日本版と US 版の差分解消を進めるべきと考えます。リポジトリが別々だと、開発がやりづらいことが理由です。

- 次の段階で、より開発工数を減らせるよう、リポジトリ内での重複を減らしていきたいです。
- 例えば、外部公開・ログイン認証ありのレコード一覧画面のコードは、`list-record.js`, `p-list-record.js`などが該当します。
- これらを見てみるとわかりますが、同じようなコードが散見されます。
- 共通的に使うコードは別ファイルに切り出して保守しやすい形にするといったことができていないため、これも積極的に改善を進めたいです。


- ただし、今時点で既にビルドを工夫して行なっているので、単にファイルを分けて`require`, `import` するだけで達成できるはずです。US 版との差分が解消できているファイルから積極的に実装できるはずです。





